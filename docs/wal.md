# WAL.

WAL это аббревиатура для Write Ahead Log. WAL хранит "намерения" сделать что-то и применяется как способ надёжно 
откатить, докатить, либо привести систему в согласованное состояние при неудаче операции.

## Простой пример работы с WAL.

Допустим, у нас есть сервисы A и B, где:

* Сервис A предоставляет CRUD для "пользователей", причём C (создание) пользователя создаёт его в неактивном состоянии.
* Сервис B предоставляет CRUD для "профилей пользователей"
* Пользователь с профилем должен становится активным.

Таким образом, для создания пользователя в рамках системы нужно:

1. Создать пользователя U с ником N(U) в A
2. Создать профиль для пользователя U с идентификатором ID(U) в B
3. Сделать пользователя U с идентификатором ID(U) активным (с помощью метода обновления в A)

Любой из этих шагов может привести к ошибке. Допустим, мы приняли следующее правило обработки ошибок при создании:

* Если в результате процесса пользователь был создан и сделан активным — кроме случая успехов на всех шагах это так же
  может произойти и когда ошибка произошла только на третьем шаге — то оставляем как есть, а иначе нужно удалить
  данные профиля и данные самого неактивного пользователя.

С помощью WAL это запишется в виде:

1. Создаём сессию S в WAL-е
2. Пишем в S данные создаваемого пользователя U. Если ошибка то выходим.
3. Создаём пользователя U в A
4. Если ошибка то закрываем S (не удаляем) и выходим.
5. Пишем в S идентификатор созданного пользователя. Если ошибка то выходим.
6. Создаём профиль пользователя U в B добавляя в U идентификатор созданного пользователя.
7. Делаем пользователя в A активным.
8. Если ошибка то выходим.
9. Удаляем сессию S.

И добавляем ручку для отработки создания пользователя.

1. Получаем от WAL данные сессии S.
2. Если в S нет идентификатора, то удаляем пользователя с данным ником N(U), удаляем сессию S и выходим.
3. Иначе смотрим статус пользователя с данным идентификатором.
   1. Если он активен, то удаляем сессию S и выходим.
   2. Иначе:
      1. Удаляем профиль для данного пользователя.
      2. Удаляем запись для данного пользователя.
      3. Удаляем сессию S и выходим.

При работе данной ручки, при получении ошибки мы сразу выходим. Запуск ручку производится WAL-ом тогда, когда наступает
время "повторения" сессии.