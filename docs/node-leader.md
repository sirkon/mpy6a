# Работа лидера

Перед прочтением этого материала необходимо ознакомиться с 
[принципом функционирования одиночного сервиса](node-single.md)

## Отличия кластерного режима работы от одиночного.

* В кластерном режиме работы имеются подключения до последователей и синхронизирующихся узлов.
* Имеется фоновый процесс, который, если последователям давно не отправляись операции, шлёт "пустую" операцию, т.н. 
  "heartbeat".

## Штатное функционирование.

### Обработка потока данных от клиентов.

1. Конструируем соответствующую операцию.
2. Отправляем её последователям.
3. Если 1 + "кол-во ОК от последователей" не меньше чем величина кворума, то применяем операцию к состоянию.
4. В случае успеха изменения состояния шлём клиенту подтверждение успеха операции.

### Обработка потока данных от последователей.

Если последователь вдруг присылает данные которые имеют больший срок чем текущий кластера, то переключаемся в 
последователя и сообщаем об этом решении всем синхронизирующимся.

### Обработка данных от синхронизирующихся.

Синхронизирующийся присылает свой текущий индекс состояния и свои дескрипторы файлов. 

* Если синхронизирующийся ещё достаточно свеж и может быть доведён до актуального состояния из хранимого лога операций, 
  то переводим его в "последователя" и начинаем отдавать отсутствующие у него элементы лога, отдавая не менее двух 
  операций за раз, чтобы когда-нибудь завершить этот процесс.
* Иначе создаём "логический лог" и отдаём данные из него.
