# mpy6a.

Или просто **труба**. Это стейт-машина пре

WAL это аббревиатура для Write Ahead Log. WAL хранит "намерения" сделать что-то и применяется как способ надёжно 
откатить операцию, докатить её, либо привести систему в согласованное состояние при неудаче операции.

# Базовая клиентская функциональность.

Объектами системы на высоком уровне являются:

1. Сама труба.
2. Клиенты трубы.
3. 

## Простой пример работы с WAL.

Допустим, у нас есть сервисы A и B, где:

* Сервис A предоставляет CRUD для "пользователей".
* Сервис B обеспечивает индексацию для поиска пользователей, ну и поиск.
* Пользователь должен искаться после создания.

Таким образом, правильное создание пользователя в рамках системы должно проходить как:

1. Создать пользователя U в A c данным ником N(U).
2. Индексировать данного пользователя после создания.

Любой из этих шагов может привести к ошибке. Допустим, мы приняли следующее правило обработки ошибок при создании:

* Если в результате процесса пользователь был создан и проиндексирован — кроме случая успехов на всех шагах это так же
  может произойти и когда ошибка произошла только на втором шаге — то оставляем как есть, а иначе нужно удалить
  данные пользователя если они есть.

С помощью WAL это запишется в виде:

1. Создаём сессию S в WAL-е
2. Пишем в S данные создаваемого пользователя U. Если ошибка то выходим.
3. Создаём пользователя U в A
4. Если ошибка то закрываем S (не удаляем) и выходим.
5. Пишем в S идентификатор созданного пользователя. Если ошибка то выходим.
6. Индексируем созданного пользователя в B.
8. Если ошибка то выходим.
9. Удаляем сессию S.

И добавляем ручку для отработки создания пользователя.

1. Получаем от WAL данные сессии S.
2. Если в S нет идентификатора, то ищем пользователя по нику N(U), иначе запрашиваем его по идентификатору.
3. Если пользователь не найден, то удаляем сессию и выходим.
4. Индексируем полученного по любому аттрибуту пользователя.
5. При успехе удаляем сессию и выходим.


При работе данной ручки, при получении ошибки мы сразу выходим. Запуск ручку производится WAL-ом тогда, когда наступает
время "повторения" сессии.