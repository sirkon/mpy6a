# Синхронизация свежих узлов

Перед чтением  этого материала нужно ознакомиться с [глоссарием](glossary.md), описание [хранилища](storage.md) и
методикой [повтора](repeat.md) сохранённых сессий .

* При старте нового узла.
* При переподключении старого узла.
* И т.п.

Может потребоваться довести его состояние до того момента, чтобы он смог, в ответ на AppendEntries, ответить согласием,
т.е. он должен содержать через какое-то время все актуальные данные обоих видов сессий, активных и сохранённых.

Здесь два возможных случая:

1. На лидере ещё есть лог от состояния на новом узле.
2. Соотв. лога от состояния нового узла уже не осталось.

Первый случай реализуется просто довозом отсутствующих записей. А второй сейчас будем разбирать.

## Доведение нового узла до актуального состояния.

Итак у нас есть новый узел N со своим состоянием S(N) и лидер L в состоянии S(L). Нужно привести N в состояние S(L).

Будем это делать как:

1) Доводим N до состояния последнего слепка SL(L) на S.
2) Если поcле доведения N до SL(L) на S есть лог от SL:=SL(L) до S(L), то сводим задачу к первому способу синхронизации.
3) Если лога от SL до S(L) нет, то это означает что точно есть новый слепок SL'(L), повторяем пункт 1 и последующие.

Так что требуется только описать доведение состояния от данного до состояния описанного в слепке. Смотрим следующий
раздел.

## Доведение нового узла до состояния описанного в слепке.

Как было описано в материале посвящённом подсистеме хранения, слепок на момент X полностью описывает состояние на 
момент X:

* Активные на этот момент сессии находятся в слепке.
* Дескрипторы файлов так же сериализованы с слепке.
* Сохранённые сессии находятся в слепке и в других файлах, описанных в дескрипторах.

Так что нужно:

1. Перевезти все файлы.

### Перевоз файлов.

1. Новый узел посылает свои дескрипторы файлов.
2. Лидер сравнивает эти дескрипторы со своими и принимает решения:
   1. Удалить те файлы, которых нет на лидере.
   2. Файлы, размер которых на N меньше чем на лидере, должны быть дописаны до состояния лидера.
   3. Файлы, которых нет N, должны быть туда доставлены полностью.
   4. В процессе на N меняются дескрипторы.
3. Завершаем перевоз файлов и добавляем доставленный таким образом на N слепок SL в лог слепков.
4. Переформируем состояние на N в соответствии с содержимым SL.

Замечание: дескрипторы на N формируются исходя из размера файлов, а не того, что описано в (последнем) слепке на N:

* В ходе синхронизации файлы всё равно не превзойдут в размере то, что имеется на L.
* Таким образом мы добиваемся инкрементальности синхронизации, когда при отвале будет не будет перезапроса уже отданных
  данных, как при отвале L, так и при проблемах на N.




