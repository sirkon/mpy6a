# RAFT

В данном материале описана модификация RAFT для нужд разрабатываемой системы.

В описании подсистемы [сохранения сессий](saved_sessions_storage.md) было упомянуто, что операции сброса контейнера
и объединения источников будут писаться в лог. Вроде хорошо, но есть одна сложность: намерение описано, но при таком
подходе неизвестно, когда и будет ли вообще завершена операция, которая может завершиться с ошибкой. Т.е. должна
быть операция, которая регистрирует успешное создание нового источника, ну или говорит, что операция завершилась
неуспехом.

С началом всё понятно: оператор дожидается своей очереди и пишет в очередь операцию. А что насчёт подтверждения или
сброса?

Предлагается следующий подход:

- Состояние хранит флаг прохождения в данный момент операции. Он выставляется операцией создания источника перед
  тем как в фоне начинается создание источника.
- Состояние хранит битовый массив, каждая клетка в котором соответствует последователю.
- Далее логика различается для лидера и последователей:
  - Лидер создаёт источник и дожидается определённое время подтверждения от последователей.
  - Последователь, завершив создание у себя, добавляет в ответ на `AppendEntries` флаг, что операция завершена.
    Такие операции, напомню, никогда не пересекаются, поэтому достаточно одного флага без указания индекса операции.
    При этом проставляют это значение только те ведомые, которые идут нога в ногу с лидером. Потому что возможны 
    ситуации, когда сильно отставший ведомый будет говорить о завершении **предыдущей** операции, сбивая лидера
    с толку. А с таким подходом мы просто используем битовые маски вместо bool, например uint32,
    в ответ на `AppendEntries`. В первом бите храним true/false, во втором обсуждаемый флаг и т.д.
  - Когда лидер получает флаг с последователя, он активирует его бит в битовом массиве.
  - Когда количество включённых битов достигает кворумного и источник на лидере готов, создаётся оператор успешного
    завершения создания источника, который засылает операцию `SourceCommit` и завершает создание.
  - В случае когда был превзойдено допустимое время создания, а кворум не достигнут, то рассылается операция
    `SourceXXX`, которая говорит об неуспехе создания источника. Данная операция обнуляет флаг прохождения
    операции и очищает битовый массив.
  - Когда последователи получают `SourceCommit|XXX`, они выполняют соответствующую операцию и перестают
    проставлять флаг об завершении создания.
- Неуспех операции на хосте говорит о наличии критических проблем и должен приводить к останову системы.
